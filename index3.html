<!DOCTYPE html>
<meta charset="utf-8">
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css"
    integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous" />
<style>


#treeContainer {
  overflow:hidden;
}
.node circle {
  fill: #fff;
  stroke: steelblue;
  stroke-width: 3px;
}

.node text {
  font: 12px sans-serif;
}

.node-text {
  background-color: rgb(169, 186, 218);
  padding:10px;
  border-radius: 5px;
}

.link {
  fill: none;
  stroke: #ccc;
  stroke-width: 2px;
}

#expanded {
  background-color: lightgreen;
}
.hidden {
  display:none;
}

.fade-in {
animation: fadeIn ease .2s;
-webkit-animation: fadeIn ease .2s;
-moz-animation: fadeIn ease .2s;
-o-animation: fadeIn ease .2s;
-ms-animation: fadeIn ease .2s;
}

.popup-text {
  text-decoration: underline;
  color: blue;
}

.popup-btn {
  float: right;
  color: white;
  background-color: green;
}

.node-text::after { 
   content: " ";
   display: block; 
   height: 0; 
   clear: both;
}

#homeBtn {
  margin-left: 300px;
}

</style>
<body>
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark my-nav">
    <a class="navbar-brand" href="#">Tree 3</a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav"
      aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav ml-auto">
        <li class="nav-item active">
          <a class="nav-link" href="./index.html">Home <span class="sr-only">(current)</span></a>
        </li>
        <li class="nav-item active">
          <a class="nav-link" href="#">Features</a>
        </li>
        <li class="nav-item active">
          <a class="nav-link" href="#">FAQ</a>
        </li>
        <li class="nav-item active">
          <a class="nav-link" href="#">Resources</a>
        </li>
      </ul>
    </div>
  </nav>
  <div class="container-fluid" id="treeContainer">
  </div>
  <button type="button" class="btn btn-primary" id="homeBtn">Go Back</button>

 
  
 <!-- Modal -->
<div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLongTitle">Extra Information</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        1914 translation by H. Rackham
"But I must explain to you how all this mistaken idea of denouncing pleasure and praising pain was born and I will give you a complete account of the system, and expound the actual teachings of the great explorer of the truth, the master-builder of human happiness. No one rejects, dislikes, or avoids pleasure itself, because it is pleasure, but because those who do not know how to pursue pleasure rationally encounter consequences that are extremely painful. Nor again is there anyone who loves or pursues or desires to obtain pain of itself, because it is pain, but because occasionally circumstances occur in which toil and pain can procure him some great pleasure. To take a trivial example, which of us ever undertakes laborious physical exercise, except to obtain some advantage from it? But who has any right to find fault with a man who chooses to enjoy a pleasure that has no annoying consequences, or one who avoids a pain that produces no resultant pleasure?"
<br><br>
Section 1.10.33 of "de Finibus Bonorum et Malorum", written by Cicero in 45 BC
"At vero eos et accusamus et iusto odio dignissimos ducimus qui blanditiis praesentium voluptatum deleniti atque corrupti quos dolores et quas molestias excepturi sint occaecati cupiditate non provident, similique sunt in culpa qui officia deserunt mollitia animi, id est laborum et dolorum fuga. Et harum quidem rerum facilis est et expedita distinctio. Nam libero tempore, cum soluta nobis est eligendi optio cumque nihil impedit quo minus id quod maxime placeat facere possimus, omnis voluptas assumenda est, omnis dolor repellendus. Temporibus autem quibusdam et aut officiis debitis aut rerum necessitatibus saepe eveniet ut et voluptates repudiandae sint et molestiae non recusandae. Itaque earum rerum hic tenetur a sapiente delectus, ut aut reiciendis voluptatibus maiores alias consequatur aut perferendis doloribus asperiores repellat."

      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>



  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.3/umd/popper.min.js" integrity="sha384-vFJXuSJphROIrBnz7yo7oB41mKfc8JzQZiCq4NCceLEaO4IHwicKwpJf9c9IpFgh" crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/js/bootstrap.min.js" integrity="sha384-alpBpkh1PFOepccYVYDB4do5UnbKysX5WZXm3XxPqe5iKTfUKjNkCk9SaVuEZflJ" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/4.13.0/d3.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.5/lodash.js"></script>
  
<script>

let exp3 = false;
$(document).ready(function(){
// $(".expand").hover(function(){
  
//     $(this).css("background-color", "lightgreen");
//     $(this).css("margin-bottom", "-10px");
//     $(this).css("padding-bottom", "10px");
//     $(this).addClass("fade-in");
//     $(this).siblings("#expanded").removeClass("hidden");
//     $(this).siblings("#expanded").addClass("fade-in");

//   }, function(){
//     $(this).css("background-color", "transparent");
//     $("#expanded").addClass("hidden");
//   });
});

$("#homeBtn").on("click",  function() {
       window.location.href = "index.html";
  });


var fields =  [
        "id",
        "name",
        "tag.analytics.aggname",
        "tag.analytics.jobname",
        "tag.analytics.metric",
        "tag.kubernetes.namespace.creationTimestamp",
        "tag.kubernetes.namespace.name",
        "tag.kubernetes.namespace.phase",
        "tag.kubernetes.namespace.uid",
        "tag.kubernetes.node.ExternalIP",
        "tag.kubernetes.node.Hostname",
        "tag.kubernetes.node.InternalIP",
        "tag.kubernetes.node.creationTimestamp",
        "tag.kubernetes.node.name",
        "tag.kubernetes.node.uid",
        "tag.kubernetes.pod.creationTimestamp",
        "tag.kubernetes.pod.hostIP",
        "tag.kubernetes.pod.label.app",
        "tag.kubernetes.pod.label.chart",
        "tag.kubernetes.pod.label.component",
        "tag.kubernetes.pod.label.controller-revision-hash",
        "tag.kubernetes.pod.label.heritage",
        "tag.kubernetes.pod.label.k8s-app",
        "tag.kubernetes.pod.label.kubernetes.io/cluster-service",
        "tag.kubernetes.pod.label.name",
        "tag.kubernetes.pod.label.pod-template-generation",
        "tag.kubernetes.pod.label.pod-template-hash",
        "tag.kubernetes.pod.label.release",
        "tag.kubernetes.pod.label.tier",
        "tag.kubernetes.pod.name",
        "tag.kubernetes.pod.phase",
        "tag.kubernetes.pod.podIP",
        "tag.kubernetes.pod.uid",
        "tag.kubernetes.service",
        "tag.kubernetes.type",
        "tag.collector",
        "units"
    ]

var key = "tag.kubernetes.pod.label.release";

const buildTree = (fields) => {
  let tree = {
    "name": "tags",
    "children": []
  }
  
  const addNodes = (tag) => {
    for (let i = 0; i < root.children.length; i++) {
      if (tag === root.children[i].name) {
        root = root.children[i];
        return;
      } 
    }
    root.children.push({
      'name': tag,
      children: []
    })
    root = root.children[root.children.length-1]
  }
  
  fields.forEach((field) => {
    tags = field.split('.');
    root = tree;
    tags.forEach(addNodes)
  })
  return tree;
}




var treeData = buildTree(fields)
  // {
  //   "name": "Top Level",
  //   "children": [
  //     { 
  //       "name": "Level 2: A",
  //       "children": [
  //         { "name": "Son of A" },
  //         { "name": "Daughter of A" }
  //       ]
  //     },
  //     { "name": "Level 2: B",
  //       "children":[
  //         { "name": "Son of B" },
  //         { "name": "Daughter of B" }
  //       ]
  //     }
  //   ]
  // };

// Set the dimensions and margins of the diagram
var margin = {top: 20, right: 0, bottom: 30, left: 40},
    width = window.innerWidth + 300 - margin.left - margin.right,
    height = 1000 - margin.top - margin.bottom;

// append the svg object to the body of the page
// appends a 'group' element to 'svg'
// moves the 'group' element to the top left margin
var container = document.getElementById("treeContainer");

var svg = d3.select(container).append("svg")
    .attr("id", "svg")
    .attr("width", width + margin.right + margin.left)
    .attr("height", height + margin.top + margin.bottom)
// .attr("preserveAspectRatio", "xMinYMin meet")
//   .attr("viewBox", `0 0 ${width} ${height}`)
  .append("g")
    .attr("transform", "translate("
          + margin.left + "," + margin.top + ")");



// declares a tree layout and assigns the size
var treemap = d3.tree().size([height, width]);
var i = 0,
    duration = 750,
    root;
   
// Assigns parent, children, height, depth
root = d3.hierarchy( {
    name: "<div class = 'node-text'><p class='h6'>Born abroad to US Parents</p></div>",
    type: "law",
    children: [
      {
        name: "<div class = 'node-text'><p  class='h6 expand'>Born in <span class = 'popup-text popup1'>Wedlock</span></p></div>",
        clauses: 2,
        type: "law",
        children: [
          {
            name: "<div class = 'node-text'><p  class='h6 expand'>Accepts biological relationship</p></div>",
            outcome: "pos"
          },
          {
            name: "<div class = 'node-text'><p  class='h6'>Suspects fraudulent  relationship </p><button class = 'popup-btn popup1'>+</button></div>",
            yadjust: "down",
            type: "law",
            outcome: "neg",
            children: [
              {
                name: "<div class = 'node-text'><p  class='h6 expand'>Consular office establishes proof</p><button class = 'popup-btn popup1'>+</button></div>",
                outcome: "pos"
              },
              { name: "<div class = 'node-text'><p  class='h6 expand'>Voluntary DNA test</p><button class = 'popup-btn popup1'>+</button></div>" },
              {
                name: "<div class = 'node-text'><p  class='h6 expand'>Abandons citizenship claim</p><button class = 'popup-btn popup1'>+</button></div>",
                outcome: "neg"
              }
            ]
          }
        ]
      },
      {
        name: "<div class = 'node-text'><p  class='h6 expand'>Born out of <span class = 'popup-text popup1'>Wedlock</span></p></div>",
        children: [
          {
            name: "<div class = 'node-text'><p  class='h6'>Born to US Citizen Father </p></div>",
            clauses: 2,
            type: "law",
            children: [
              {
                name: "<div class = 'node-text'><p  class='h6 expand'>Accepts biological relationship</p></div",
                outcome: "pos"
              },
              {
                name: "<div class = 'node-text'><p  class='h6'>Suspects fraudulent  relationship </p></div>",
                yadjust: "down",
                outcome: "neg",
                type: "law"
              }
            ]
          },
          {
            name: "<div class = 'node-text'><p  class='h6'>Born to US Citizen Mother </p></div>",
            clauses: 3,
            type: "law",
            children: [
              {
                name: "<div class = 'node-text'><p  class='h6 expand'>Accepts biological relationship</p></div>",
                outcome: "pos"
              },
              {
                name: "<div class = 'node-text'><p  class='h6'>Suspects fraudulent  relationship</p></div>",
                yadjust: "down",
                outcome: "neg",
                type: "law"
              }
            ]
          }
        ]
      }
    ]
  }, function(d) {
  return d.children;
});
root.x0 = height / 2;
root.y0 = 0;

// Collapse after the second level
root.children.forEach(collapse);

// collapse all
// collapse(root)
// expandOnKey(key, root);
update(root);

//Expand the tree based on key
function expandOnKey(key, root) {
  var node = root;
  var tags = key.split(".");
  while (tags.length > 0) {
    var found = false;
    var next = tags[0]
    if (node._children) {
      node._children.forEach((child) => {
        if (child.data.name === next) {
          // expand this node
          node.children = node._children;
          node._children = null;
          node = child;
          found = true;
        }
      })
    }
    if (found) {
      tags.shift()
    } else {
      return;
    }
  }
}


// Collapse the node and all it's children
function collapse(d) {
  if(d.children) {
    d._children = d.children
    d._children.forEach(collapse)
    d.children = null
  }
}
function getHeight(root) {
  if (!root) {
    return 0
  }
  let expandChildren = [0]
  if (root.children) { // if has expanded children
    expandChildren = root.children.map(ea => getHeight(ea))
  }
  const max = expandChildren.reduce((a, b) => Math.max(a,b))
  return 1 + max
}

function update(source) {
  var currentHeight = getHeight(root);
  var newWidth = window.innerWidth;
  document.getElementById("svg").style.width = newWidth;
  // Assigns the x and y position for the nodes
  var treeData = treemap(root);

  // Compute the new tree layout.
  var nodes = treeData.descendants(),
      links = treeData.descendants().slice(1);

  // Normalize for current-depth.
  nodes.forEach(function(d){ d.y = d.depth * window.innerWidth / (currentHeight+ Math.log(currentHeight-1))});
  // ****************** Nodes section ***************************
  // create tip for nodes
  // var tip = d3.tip()
  //   .attr('class', 'd3-tip')
  //   .offset([-10, 0])
  //   .html(function(d) {
  //     return getPath(d)
  //   })
  
  // Update the nodes...
  var node = svg.selectAll('g.node')
      .data(nodes, function(d) {return d.id || (d.id = ++i);    });

  

  // Enter any new modes at the parent's previous position.
  var nodeEnter = node.enter().append('g')
      .attr('class', 'node')
      .attr("transform", function(d) {
        return "translate(" + source.y0 + "," + source.x0 + ")";
    })
    .on('click', delayClick);
  // nodeEnter.call(tip);
  // Add Circle for the nodes
  nodeEnter.append('circle')
      .attr('class', 'node')
      .attr('r', 1e-6)
      .style("fill", function(d) {
          return d._children ? "lightsteelblue" : "#fff";
      })
      // .on('mouseover', tip.show) // add tip
      // .on('mouseout', tip.hide);


  var textbox_w = 270,
  textbox_h = 100; //heuristic: minimal 88 is needed for title + 2 laws
  // Add labels for the nodes
  nodeEnter
    .append("foreignObject")
    .attr("class", "txt")
    .attr("width", textbox_w - 10)
    .attr("height", (d) => (d.data.type === "law" ? textbox_h + 100 : 76)) //adjust this to ensure all text shown
    .style("transform", (d) =>
      d.data.clauses === 3
        ? "translateX(14px) translateY(-" + (textbox_h / 2 - 20) + "px)"
        : d.data.yadjust === "down"
          ? "translateX(14px) translateY(-" + (textbox_h / 2 - 20) + "px)"
          : d.data.type === "law"
            ? "translateX(14px) translateY(-" + (textbox_h / 2 - 20) + "px)"
            : "translateX(14px) translateY(-8px)"
    )
    .append("xhtml:div")
    .style("fill", "black")
    .html(function (d) {
      return d.data.name;
    });

  // UPDATE
  var nodeUpdate = nodeEnter.merge(node);
  // Transition to the proper position for the node
  nodeUpdate.transition()
    .duration(duration)
    .attr("transform", function(d) { 
        return "translate(" + d.y + "," + d.x + ")";
     });

  // Update the node attributes and style
  nodeUpdate.select('circle.node')
    .attr('r', 10)
    .style("fill", function(d) {
        if (getPath(d) === key) {
            // clicked leaf node
            return '#F88C36';
          }
        return d._children ? "lightsteelblue" : "#fff";
    })
    .attr('cursor', 'pointer');


  // Remove any exiting nodes
  var nodeExit = node.exit().transition()
      .duration(duration)
      .attr("transform", function(d) {
          return "translate(" + source.y + "," + source.x + ")";
      })
      .remove();

  // On exit reduce the node circles size to 0
  nodeExit.select('circle')
    .attr('r', 1e-6);

  // On exit reduce the opacity of text labels
  nodeExit.select('text')
    .style('fill-opacity', 1e-6);

  // ****************** links section ***************************

  // Update the links...
  var link = svg.selectAll('path.link')
      .data(links, function(d) { return d.id; });

  // Enter any new links at the parent's previous position.
  var linkEnter = link.enter().insert('path', "g")
      .attr("class", "link")
      .attr('d', function(d){
        var o = {x: source.x0, y: source.y0}
        return diagonal(o, o)
      });

  // UPDATE
  var linkUpdate = linkEnter.merge(link);

  // Transition back to the parent element position
  linkUpdate.transition()
      .duration(duration)
      .attr('d', function(d){ return diagonal(d, d.parent) });

  // Remove any exiting links
  var linkExit = link.exit().transition()
      .duration(duration)
      .attr('d', function(d) {
        var o = {x: source.x, y: source.y}
        return diagonal(o, o)
      })
      .remove();

  // Store the old positions for transition.
  nodes.forEach(function(d){
    d.x0 = d.x;
    d.y0 = d.y;
  });

  // Creates a curved (diagonal) path from parent to the child nodes
  function diagonal(s, d) {

    var path = `M ${s.y} ${s.x}
            C ${(s.y + d.y) / 2} ${s.x},
              ${(s.y + d.y) / 2} ${d.x},
              ${d.y} ${d.x}`

    return path;
  }


  function delayClick(d) {
    setTimeout(function(){ click(d); }, 10);
  }

  // Toggle children on click.
  function click(d) {
    console.log(exp3);
    if(exp3 === true) {
      return exp3 = false;
    }
    //d.children is expanded children
    //d._children is collapes children
    if (d.children) {
        d._children = d.children;
        d.children = null;
      } else {
        d.children = d._children;
        d._children = null;
      }
    update(d);
  }
  // return the path from root to this node
  function getPath(d) {
    var path = [];
    while (d.parent !== null) {
      path.unshift(d.data.name)
      d=d.parent
    }
    return path.join('.')
  }
}

$(".popup1").on("click", function() {
  exp3 = true;
})

  $(document).on("click", ".popup1", function() {
    exp3 = true;
       $("#exampleModal").modal();
     
  });


window.addEventListener('resize', _.debounce(function(){
  update(root)
}, 500));
</script>
</body>